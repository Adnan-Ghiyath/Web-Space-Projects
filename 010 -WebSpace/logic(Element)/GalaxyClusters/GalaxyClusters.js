// محاكاة عناقيد المجرات - أداة بحث علمي جامعي
// النسخة العلمية العربية - جامعة الملك عبدالعزيز

"use strict";

class محاكاة_عناقيد_المجرات {
  constructor() {
    // الأنظمة الرئيسية
    this.المشهد = null;
    this.الكاميرا = null;
    this.المصيِّر = null;
    this.التحكم = null;
    this.الساعة = new THREE.Clock();

    // البيانات العلمية
    this.العناقيد = [];
    this.هالة_المادة_المظلمة = null;
    this.الوسط_بين_المجري = null;
    this.المجرات = [];
    this.زمن_المحاكاة = 0;

    // الثوابت الفيزيائية
    this.الفيزياء = {
      ثابت_الجاذبية: 6.6743e-11, // نيوتن·م²/كجم²
      نسبة_المادة_المظلمة: 0.85,
      نسبة_المادة_الباريونية: 0.15,
      درجة_حرارة_البلازما: 1e7, // 10 مليون كلفن
      نصف_قطر_فيريالي: 3e6, // 3 ميجا فرسخ
      تشتت_السرعة: 1000, // كم/ث
    };

    // أنواع العناقيد العلمية
    this.أنواع_العناقيد = {
      منتظم: {
        الاسم: "العنقود المجري المنتظم",
        الوصف: "نظام ضخم مترابط جاذبيًا بدرجة عالية من التناظر",
        التصنيف: "النوع الأول (باوتز-مورغان)",
        الشكل: "توزيع سلس ومتناظر",
        المجرات: "500-2000 مجرة",
        الكتلة: "10¹⁴ - 10¹⁵ كتلة شمسية",
        الحجم: "2-3 ميجا فرسخ (فيريالي)",
        الحرارة: "2-10 كيلو إلكترون فولت",
        تشتت_السرعة: "800-1200 كم/ث",
        المادة_المظلمة: "85% ± 5%",
        الانزياح_الأحمر: "z = 0.02 - 0.3",
        مثال: "عنقود كوما (أبيل 1656)",
        اللون: 0x4a90e2,
        بيانات_علمية: {
          اللمعان_الأشعة_السينية: "5×10^44 إرج/ث",
          كتلة_الغاز: "10^13 - 10^14 كتلة شمسية",
          الكتلة_الكاملة: "10^15 كتلة شمسية",
          زمن_التبريد: "5-10 مليار سنة",
          المعدنية: "0.3 كتلة شمسية",
        },
      },
      غير_منتظم: {
        الاسم: "العنقود المجري غير المنتظم",
        الوصف: "عنقود حديث الاندماج أو ديناميكيًا صغير العمر",
        التصنيف: "النوع الثالث (باوتز-مورغان)",
        الشكل: "غير متناظر، يحتوي على تراكيب فرعية",
        المجرات: "100-1000 مجرة",
        الكتلة: "10^14 كتلة شمسية",
        الحجم: "1-2 ميجا فرسخ",
        الحرارة: "1-8 كيلو إلكترون فولت",
        تشتت_السرعة: "500-1000 كم/ث",
        المادة_المظلمة: "80% ± 10%",
        الانزياح_الأحمر: "z = 0.1 - 0.5",
        مثال: "عنقود العذراء",
        اللون: 0x7ed321,
        بيانات_علمية: {
          اللمعان_الأشعة_السينية: "1×10^44 إرج/ث",
          كتلة_الغاز: "5×10^13 كتلة شمسية",
          الكتلة_الكاملة: "5×10^14 كتلة شمسية",
          زمن_التبريد: "1-5 مليار سنة",
          المعدنية: "0.2 كتلة شمسية",
        },
      },
      مهيمن_CD: {
        الاسم: "العنقود المهيمن عليه بـ CD",
        الوصف: "عنقود تهيمن عليه مجرة إهليلجية عملاقة (CD)",
        التصنيف: "النوع I-II (باوتز-مورغان)",
        الشكل: "تركيز مركزي قوي",
        المجرات: "1000-10000 مجرة",
        الكتلة: "10^15 كتلة شمسية",
        الحجم: "3-5 ميجا فرسخ",
        الحرارة: "5-15 كيلو إلكترون فولت",
        تشتت_السرعة: "1200-2000 كم/ث",
        المادة_المظلمة: "90% ± 3%",
        الانزياح_الأحمر: "z = 0.05 - 0.2",
        مثال: "أبيل 2029",
        اللون: 0xff6b6b,
        بيانات_علمية: {
          اللمعان_الأشعة_السينية: "10^45 إرج/ث",
          كتلة_الغاز: "2×10^14 كتلة شمسية",
          الكتلة_الكاملة: "2×10^15 كتلة شمسية",
          زمن_التبريد: "10-15 مليار سنة",
          المعدنية: "0.4 كتلة شمسية",
        },
      },
      متحجر: {
        الاسم: "المجموعة المتحجرة",
        الوصف: "نظام قديم مستقر مع فجوة في اللمعان",
        التصنيف: "النظام المتحجر",
        الشكل: "مستقر، لا يوجد اندماجات حديثة",
        المجرات: "20-100 مجرة",
        الكتلة: "10^13 - 10^14 كتلة شمسية",
        الحجم: "0.5-1.5 ميجا فرسخ",
        الحرارة: "0.5-5 كيلو إلكترون فولت",
        تشتت_السرعة: "300-800 كم/ث",
        المادة_المظلمة: "75% ± 8%",
        الانزياح_الأحمر: "z = 0.05 - 0.3",
        مثال: "RX J1340.6+4018",
        اللون: 0x9b59b6,
        بيانات_علمية: {
          اللمعان_الأشعة_السينية: "5×10^43 إرج/ث",
          كتلة_الغاز: "10^13 كتلة شمسية",
          الكتلة_الكاملة: "5×10^14 كتلة شمسية",
          زمن_التبريد: ">10 مليار سنة",
          المعدنية: "0.3 كتلة شمسية",
        },
      },
    };

    // معلمات المحاكاة
    this.النوع_الحالي = "منتظم";
    this.عرض_المادة_المظلمة = true;
    this.عرض_الوسط_بين_المجري = true;
    this.عرض_متجهات_السرعة = false;
    this.عرض_خريطة_الحرارة = false;
    this.مقياس_الزمن_الحقيقي = true;
    this.مقياس_الزمن = 1.0;
    this.محاكاة_التصادم = false;
    this.وضع_البحث = false;

    // الواجهة العلمية
    this.لوحات_البيانات = {};
    this.المقاييس = {};

    this.تهيئة();
  }

  تهيئة() {
    this.إنشاء_المشهد();
    this.إنشاء_الكاميرا();
    this.إنشاء_المصيِّر();
    this.إنشاء_التحكم();
    this.إعداد_الإضاءة();
    this.إنشاء_بيئة_الكون();
    this.إعداد_الواجهة();
    this.إنشاء_العنقود();
    this.إعداد_مستمعي_الأحداث();
    this.بدء_الحركة();

    // تسجيل بيانات المحاكاة
    this.تسجيل_بدء_المحاكاة();
  }

  إنشاء_المشهد() {
    this.المشهد = new THREE.Scene();
    this.المشهد.background = new THREE.Color(0x000010);
    this.المشهد.fog = new THREE.Fog(0x000010, 100, 2000);
  }

  إنشاء_الكاميرا() {
    this.الكاميرا = new THREE.PerspectiveCamera(
      60, // مجال الرؤية
      window.innerWidth / window.innerHeight,
      0.1, // المدى القريب
      10000 // المدى البعيد
    );
    this.الكاميرا.position.set(0, 50, 150);
    this.الكاميرا.up.set(0, 1, 0);
  }

  إنشاء_المصيِّر() {
    this.المصيِّر = new THREE.WebGLRenderer({
      antialias: true,
      alpha: true,
      precision: "highp",
      powerPreference: "high-performance",
      logarithmicDepthBuffer: true,
    });

    this.المصيِّر.setSize(window.innerWidth, window.innerHeight);
    this.المصيِّر.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    this.المصيِّر.shadowMap.enabled = true;
    this.المصيِّر.shadowMap.type = THREE.PCFSoftShadowMap;
    this.المصيِّر.outputEncoding = THREE.sRGBEncoding;
    this.المصيِّر.toneMapping = THREE.ACESFilmicToneMapping;
    this.المصيِّر.toneMappingExposure = 1.0;

    document
      .getElementById("حاوية-العناقيد")
      .appendChild(this.المصيِّر.domElement);
  }

  إنشاء_التحكم() {
    this.التحكم = new THREE.OrbitControls(
      this.الكاميرا,
      this.المصيِّر.domElement
    );
    this.التحكم.enableDamping = true;
    this.التحكم.dampingFactor = 0.05;
    this.التحكم.screenSpacePanning = false;
    this.التحكم.minDistance = 20;
    this.التحكم.maxDistance = 1000;
    this.التحكم.maxPolarAngle = Math.PI;
    this.التحكم.minPolarAngle = 0;

    // إعدادات علمية للتحكم
    this.التحكم.rotateSpeed = 0.5;
    this.التحكم.zoomSpeed = 1.2;
    this.التحكم.panSpeed = 0.8;
  }

  إعداد_الإضاءة() {
    // إضاءة علمية واقعية
    const إضاءة_محاطة = new THREE.AmbientLight(0x333366, 0.3);
    this.المشهد.add(إضاءة_محاطة);

    // إضاءة مركزية (مثل النوى المجرية النشطة)
    const إضاءة_مركزية = new THREE.PointLight(0xffffff, 1.0, 500);
    إضاءة_مركزية.position.set(0, 0, 0);
    this.المشهد.add(إضاءة_مركزية);

    // إضاءة متعددة الاتجاهات
    const إضاءة_اتجاهية1 = new THREE.DirectionalLight(0x4466ff, 0.5);
    إضاءة_اتجاهية1.position.set(100, 50, 100);
    this.المشهد.add(إضاءة_اتجاهية1);

    const إضاءة_اتجاهية2 = new THREE.DirectionalLight(0xff6633, 0.3);
    إضاءة_اتجاهية2.position.set(-100, -50, -100);
    this.المشهد.add(إضاءة_اتجاهية2);

    // إضاءة للوهج
    const إضاءة_نصف_كروية = new THREE.HemisphereLight(0x4488aa, 0x002244, 0.3);
    this.المشهد.add(إضاءة_نصف_كروية);
  }

  إنشاء_بيئة_الكون() {
    // خلفية الكون - بيانات حقيقية
    this.إنشاء_خلفية_SDSS();

    // إضافة مجرات مرجعية
    this.إنشاء_مجرات_مرجعية();

    // إضافة نظام إحداثيات فلكية
    this.إنشاء_نظام_إحداثيات();
  }

  إنشاء_خلفية_SDSS() {
    // محاكاة خلفية مسح سلون الرقمي للسماء
    const عدد_الجسيمات = 10000;
    const هندسة = new THREE.BufferGeometry();
    const مواقع = new Float32Array(عدد_الجسيمات * 3);
    const ألوان = new Float32Array(عدد_الجسيمات * 3);
    const أحجام = new Float32Array(عدد_الجسيمات);

    for (let i = 0; i < عدد_الجسيمات; i++) {
      const مؤشر = i * 3;

      // توزيع كروي مع كثافة متناقصة
      const نصف_القطر = 500 + Math.random() * 1500;
      const ثيتا = Math.random() * Math.PI * 2;
      const فاي = Math.acos(2 * Math.random() - 1);

      مواقع[مؤشر] = نصف_القطر * Math.sin(فاي) * Math.cos(ثيتا);
      مواقع[مؤشر + 1] = نصف_القطر * Math.sin(فاي) * Math.sin(ثيتا);
      مواقع[مؤشر + 2] = نصف_القطر * Math.cos(فاي);

      // ألوان حقيقية بناءً على النوع الطيفي
      const النوع_الطيفي = Math.random();
      if (النوع_الطيفي < 0.7) {
        // نجوم التسلسل الرئيسي (G-K)
        ألوان[مؤشر] = 1.0;
        ألوان[مؤشر + 1] = 0.8 + Math.random() * 0.2;
        ألوان[مؤشر + 2] = 0.6 + Math.random() * 0.3;
      } else if (النوع_الطيفي < 0.9) {
        // نجوم زرقاء ساخنة (O-B)
        ألوان[مؤشر] = 0.4 + Math.random() * 0.3;
        ألوان[مؤشر + 1] = 0.5 + Math.random() * 0.3;
        ألوان[مؤشر + 2] = 1.0;
      } else {
        // نجوم حمراء عملاقة (M)
        ألوان[مؤشر] = 1.0;
        ألوان[مؤشر + 1] = 0.4 + Math.random() * 0.2;
        ألوان[مؤشر + 2] = 0.2 + Math.random() * 0.2;
      }

      أحجام[i] = 0.1 + Math.random() * 0.3;
    }

    هندسة.setAttribute("position", new THREE.BufferAttribute(مواقع, 3));
    هندسة.setAttribute("color", new THREE.BufferAttribute(ألوان, 3));
    هندسة.setAttribute("size", new THREE.BufferAttribute(أحجام, 1));

    const مادة = new THREE.PointsMaterial({
      size: 0.15,
      vertexColors: true,
      transparent: true,
      opacity: 0.7,
      sizeAttenuation: true,
    });

    const الخلفية = new THREE.Points(هندسة, مادة);
    الخلفية.userData = { type: "خلفية_SDSS" };
    this.المشهد.add(الخلفية);
    this.العناقيد.push(الخلفية);
  }

  إنشاء_مجرات_مرجعية() {
    // إضافة مجرات مرجعية مشهورة
    const المراجع = [
      { الاسم: "درب التبانة", الموقع: [100, 0, 0], النوع: "مصراعية" },
      { الاسم: "أندروميدا", الموقع: [-100, 0, 0], النوع: "حلزونية" },
      { الاسم: "M87", الموقع: [0, 50, 100], النوع: "إهليلجية" },
      { الاسم: "قنطورس A", الموقع: [50, -50, -50], النوع: "عدسية" },
    ];

    المراجع.forEach((مرجع) => {
      const مجرة = this.إنشاء_مجرة_علمية(
        new THREE.Vector3(...مرجع.الموقع),
        مرجع.النوع,
        2.0
      );
      مجرة.userData.مرجعية = true;
      مجرة.userData.الاسم = مرجع.الاسم;
    });
  }

  إنشاء_نظام_إحداثيات() {
    // نظام إحداثيات فلكية
    const نصف_القطر = 300;
    const القطع = 64;

    // خط الاستواء السماوي
    const هندسة_الاستواء = new THREE.RingGeometry(
      نصف_القطر,
      نصف_القطر + 0.5,
      القطع
    );
    const مادة_الاستواء = new THREE.MeshBasicMaterial({
      color: 0x00ffff,
      transparent: true,
      opacity: 0.1,
      side: THREE.DoubleSide,
    });
    const الاستواء = new THREE.Mesh(هندسة_الاستواء, مادة_الاستواء);
    الاستواء.rotation.x = Math.PI / 2;
    this.المشهد.add(الاستواء);

    // محور الزوال
    const هندسة_الزوال = new THREE.TorusGeometry(
      نصف_القطر,
      0.5,
      8,
      64,
      Math.PI
    );
    const مادة_الزوال = new THREE.MeshBasicMaterial({
      color: 0xff00ff,
      transparent: true,
      opacity: 0.1,
    });
    const الزوال = new THREE.Mesh(هندسة_الزوال, مادة_الزوال);
    this.المشهد.add(الزوال);
  }

  إنشاء_العنقود() {
    // مسح العنقود السابق
    this.مسح_العنقود_السابق();

    const بيانات_النوع = this.أنواع_العناقيد[this.النوع_الحالي];

    // إنشاء العنقود العلمي
    this.إنشاء_عنقود_علمي(بيانات_النوع);

    // إنشاء هالة المادة المظلمة
    if (this.عرض_المادة_المظلمة) {
      this.إنشاء_توزيع_المادة_المظلمة(بيانات_النوع);
    }

    // إنشاء الوسط بين المجرات
    if (this.عرض_الوسط_بين_المجري) {
      this.إنشاء_الوسط_بين_المجري(بيانات_النوع);
    }

    // إضافة المقاييس والبيانات
    this.إنشاء_مقاييس_علمية(بيانات_النوع);

    // تحديث الواجهة العلمية
    this.تحديث_الواجهة_العلمية(بيانات_النوع);
  }

  إنشاء_عنقود_علمي(بيانات_النوع) {
    const نصف_قطر_العنقود = this.الحصول_على_نصف_قطر_العنقود(بيانات_النوع);
    const عدد_المجرات = this.الحصول_على_عدد_المجرات(بيانات_النوع);

    // إنشاء المجرات بناءً على دالة الكتلة
    for (let i = 0; i < عدد_المجرات; i++) {
      const الكتلة = this.توليد_كتلة_المجرة(i, عدد_المجرات);
      const النوع = this.تحديد_نوع_المجرة(الكتلة);
      const الموقع = this.حساب_موقع_المجرة(بيانات_النوع, i, عدد_المجرات);
      const السرعة = this.حساب_سرعة_المجرة(الموقع, نصف_قطر_العنقود);

      this.إنشاء_مجرة_علمية(الموقع, النوع, الكتلة, السرعة);
    }

    // إنشاء المجرة المركزية العملاقة
    this.إنشاء_المجرة_المركزية_العملاقة(بيانات_النوع);

    // تسجيل بيانات المحاكاة
    this.تسجيل_بيانات_العنقود(بيانات_النوع, عدد_المجرات);
  }

  الحصول_على_نصف_قطر_العنقود(بيانات_النوع) {
    // حساب نصف القطر الفيريالي
    const نصف_القطر_الأساسي =
      بيانات_النوع === this.أنواع_العناقيد.مهيمن_CD
        ? 50
        : بيانات_النوع === this.أنواع_العناقيد.منتظم
        ? 40
        : بيانات_النوع === this.أنواع_العناقيد.غير_منتظم
        ? 30
        : 25;
    return نصف_القطر_الأساسي;
  }

  الحصول_على_عدد_المجرات(بيانات_النوع) {
    // عدد المجرات بناءً على نوع العنقود
    const الأعداد = {
      منتظم: 80,
      غير_منتظم: 40,
      مهيمن_CD: 120,
      متحجر: 25,
    };
    return الأعداد[this.النوع_الحالي] || 50;
  }

  توليد_كتلة_المجرة(مؤشر, المجموع) {
    // توزيع كتلة المجرات حسب دالة Schechter
    const ألفا = -1.25; // معامل دالة Schechter
    const Mstar = 1e11; // الكتلة المميزة

    // توليد كتلة عشوائية مع التوزيع الصحيح
    const u = Math.random();
    const الكتلة = Mstar * Math.pow(-Math.log(u), 1 / (ألفا + 1));

    // تطبيق حدود واقعية
    return Math.max(1e9, Math.min(1e12, الكتلة));
  }

  تحديد_نوع_المجرة(الكتلة) {
    // تحديد نوع المجرة بناءً على الكتلة والبيئة
    if (الكتلة > 1e11) {
      return Math.random() < 0.7 ? "إهليلجية" : "عدسية";
    } else if (الكتلة > 3e10) {
      const عشوائي = Math.random();
      if (عشوائي < 0.4) return "حلزونية";
      if (عشوائي < 0.7) return "عدسية";
      return "إهليلجية";
    } else {
      const عشوائي = Math.random();
      if (عشوائي < 0.6) return "حلزونية";
      if (عشوائي < 0.8) return "غير منتظمة";
      return "قزمة";
    }
  }

  حساب_موقع_المجرة(بيانات_النوع, مؤشر, المجموع) {
    const نصف_قطر_العنقود = this.الحصول_على_نصف_قطر_العنقود(بيانات_النوع);

    // توزيع King profile للمجرات في العنقود
    const نصف_قطر_اللب = نصف_قطر_العنقود * 0.2;
    const نصف_قطر_المد = نصف_قطر_العنقود;

    // توليد مسافة شعاعية مع توزيع King
    let نصف_القطر;
    do {
      const u = Math.random();
      نصف_القطر = نصف_قطر_اللب * Math.sqrt(1 / (1 - u) - 1);
    } while (
      نصف_القطر > نصف_قطر_المد ||
      Math.random() > Math.exp(-نصف_القطر / نصف_قطر_اللب)
    );

    // زوايا عشوائية
    const ثيتا = Math.random() * Math.PI * 2;
    const فاي = Math.acos(2 * Math.random() - 1);

    return new THREE.Vector3(
      نصف_القطر * Math.sin(فاي) * Math.cos(ثيتا),
      نصف_القطر * Math.sin(فاي) * Math.sin(ثيتا) * 0.6, // تسطيح
      نصف_القطر * Math.cos(فاي)
    );
  }

  حساب_سرعة_المجرة(الموقع, نصف_قطر_العنقود) {
    // حساب السرعة بناءً على الملف السرعي الفيريالي
    const r = الموقع.length();
    const سيجما = this.الفيزياء.تشتت_السرعة;

    // سرعة فيريالية مع تبعثر غوسي
    const v_r =
      سيجما * Math.sqrt(r / نصف_قطر_العنقود) * (Math.random() - 0.5) * 2;
    const v_theta =
      سيجما * Math.sqrt(r / نصف_قطر_العنقود) * (Math.random() - 0.5) * 2;
    const v_phi =
      سيجما * Math.sqrt(r / نصف_قطر_العنقود) * (Math.random() - 0.5) * 2;

    return new THREE.Vector3(v_r * 0.001, v_theta * 0.001, v_phi * 0.001);
  }

  إنشاء_مجرة_علمية(الموقع, النوع, الكتلة, السرعة = new THREE.Vector3()) {
    const الحجم = Math.cbrt(الكتلة / 1e11) * 2; // علاقة كتلة-حجم

    const مجموعة_المجرة = new THREE.Group();
    مجموعة_المجرة.position.copy(الموقع);

    // تخزين البيانات العلمية
    مجموعة_المجرة.userData = {
      النوع: النوع,
      الكتلة: الكتلة,
      الحجم: الحجم,
      الموقع: الموقع.clone(),
      السرعة: السرعة.clone(),
      اللمعان: this.حساب_اللمعان(الكتلة, النوع),
      اللون: this.الحصول_على_لون_علمي(النوع, الكتلة),
      سرعة_الدوران: (0.001 + Math.random() * 0.002) / (الحجم + 0.5),
      الخصائص_العلمية: {
        الكتلة_النجمية: الكتلة,
        كتلة_الغاز: الكتلة * 0.1,
        معدل_تشكل_النجوم: this.حساب_معدل_تشكل_النجوم(النوع, الكتلة),
        المعدنية: 0.02 + Math.random() * 0.01,
        العمر: (5 + Math.random() * 8) * 1e9, // مليارات السنين
      },
    };

    // إنشاء المجرة بناءً على النوع
    switch (النوع) {
      case "حلزونية":
        this.إنشاء_نموذج_مجرة_حلزونية(
          مجموعة_المجرة,
          الحجم,
          مجموعة_المجرة.userData.اللون
        );
        break;
      case "إهليلجية":
        this.إنشاء_نموذج_مجرة_إهليلجية(
          مجموعة_المجرة,
          الحجم,
          مجموعة_المجرة.userData.اللون
        );
        break;
      case "عدسية":
        this.إنشاء_نموذج_مجرة_عدسية(
          مجموعة_المجرة,
          الحجم,
          مجموعة_المجرة.userData.اللون
        );
        break;
      case "قزمة":
        this.إنشاء_نموذج_مجرة_قزمة(
          مجموعة_المجرة,
          الحجم,
          مجموعة_المجرة.userData.اللون
        );
        break;
      case "غير منتظمة":
        this.إنشاء_نموذج_مجرة_غير_منتظمة(
          مجموعة_المجرة,
          الحجم,
          مجموعة_المجرة.userData.اللون
        );
        break;
    }

    // إضافة توهج واقعي
    this.إنشاء_وهج_علمي(مجموعة_المجرة, الحجم, مجموعة_المجرة.userData.اللون);

    this.المشهد.add(مجموعة_المجرة);
    this.المجرات.push(مجموعة_المجرة);
    this.العناقيد.push(مجموعة_المجرة);

    return مجموعة_المجرة;
  }

  حساب_اللمعان(الكتلة, النوع) {
    // حساب اللمعان بناءً على الكتلة والنوع
    let نسبة_الكتلة_لللمعان;
    switch (النوع) {
      case "إهليلجية":
        نسبة_الكتلة_لللمعان = 5;
        break;
      case "عدسية":
        نسبة_الكتلة_لللمعان = 4;
        break;
      case "حلزونية":
        نسبة_الكتلة_لللمعان = 2;
        break;
      default:
        نسبة_الكتلة_لللمعان = 1;
    }
    return الكتلة * نسبة_الكتلة_لللمعان;
  }

  الحصول_على_لون_علمي(النوع, الكتلة) {
    // ألوان علمية بناءً على النوع والكتلة
    const الألوان = {
      إهليلجية: new THREE.Color().setHSL(0.05, 0.7, 0.5), // أحمر-برتقالي
      عدسية: new THREE.Color().setHSL(0.8, 0.6, 0.6), // وردي-بنفسجي
      حلزونية: new THREE.Color().setHSL(0.6, 0.8, 0.6), // أزرق
      قزمة: new THREE.Color().setHSL(0.3, 0.5, 0.5), // أخضر باهت
      غير_منتظمة: new THREE.Color().setHSL(0.15, 0.8, 0.6), // أصفر-أخضر
    };

    const اللون_الأساسي = الألوان[النوع] || الألوان.حلزونية;

    // تعديل اللون بناءً على الكتلة
    if (الكتلة > 5e11) {
      اللون_الأساسي.offsetHSL(0.0, 0.0, -0.2); // أغمق
    }

    return اللون_الأساسي;
  }

  حساب_معدل_تشكل_النجوم(النوع, الكتلة) {
    // حساب معدل تشكل النجوم (كتلة شمسية/سنة)
    switch (النوع) {
      case "حلزونية":
      case "غير منتظمة":
        return 0.1 + Math.random() * 5; // 0.1-5 كتلة شمسية/سنة
      case "قزمة":
        return 0.01 + Math.random() * 0.5; // 0.01-0.5 كتلة شمسية/سنة
      default:
        return 0.001 + Math.random() * 0.1; // تشكل نجوم منخفض
    }
  }

  إنشاء_نموذج_مجرة_حلزونية(المجموعة, الحجم, اللون) {
    const التفاصيل = 32;

    // الانتفاخ المركزي
    const هندسة_الانتفاخ = new THREE.SphereGeometry(
      الحجم * 0.4,
      التفاصيل,
      التفاصيل
    );
    const مادة_الانتفاخ = new THREE.MeshPhongMaterial({
      color: اللون,
      emissive: اللون,
      emissiveIntensity: 0.3,
      shininess: 30,
      specular: new THREE.Color(0x333333),
    });
    const الانتفاخ = new THREE.Mesh(هندسة_الانتفاخ, مادة_الانتفاخ);
    المجموعة.add(الانتفاخ);

    // القرص الرقيق
    const هندسة_القرص = new THREE.CylinderGeometry(
      الحجم * 1.2,
      الحجم * 1.2,
      الحجم * 0.1,
      التفاصيل * 2
    );
    const مادة_القرص = new THREE.MeshPhongMaterial({
      color: اللون,
      transparent: true,
      opacity: 0.4,
      side: THREE.DoubleSide,
      shininess: 50,
    });
    const القرص = new THREE.Mesh(هندسة_القرص, مادة_القرص);
    القرص.rotation.x = Math.PI / 2;
    المجموعة.add(القرص);

    // الأذرع الحلزونية
    this.إنشاء_أذرع_حلزونية(المجموعة, الحجم, اللون);
  }

  إنشاء_أذرع_حلزونية(المجموعة, الحجم, اللون) {
    const عدد_الأذرع = 2 + Math.floor(Math.random() * 2);
    const عدد_الجسيمات = 500;

    const الهندسة = new THREE.BufferGeometry();
    const المواقع = new Float32Array(عدد_الجسيمات * 3);
    const الألوان = new Float32Array(عدد_الجسيمات * 3);
    const الأحجام = new Float32Array(عدد_الجسيمات);

    for (let i = 0; i < عدد_الجسيمات; i++) {
      const مؤشر = i * 3;
      const t = i / عدد_الجسيمات;

      // إحداثيات الحلزون اللوغاريتمي
      const الذراع = Math.floor(Math.random() * عدد_الأذرع);
      const الزاوية = (الذراع / عدد_الأذرع) * Math.PI * 2 + t * Math.PI * 6;
      const نصف_القطر = الحجم * 0.5 + t * الحجم * 2;
      const عامل_الحلزون = 0.3;

      const x =
        Math.cos(الزاوية + Math.log(نصف_القطر + 1) * عامل_الحلزون) * نصف_القطر;
      const y = (Math.random() - 0.5) * الحجم * 0.05;
      const z =
        Math.sin(الزاوية + Math.log(نصف_القطر + 1) * عامل_الحلزون) * نصف_القطر;

      المواقع[مؤشر] = x;
      المواقع[مؤشر + 1] = y;
      المواقع[مؤشر + 2] = z;

      // ألوان النجوم: مناطق HII زرقاء، نجوم قديمة حمراء
      if (t < 0.3) {
        الألوان[مؤشر] = 0.3;
        الألوان[مؤشر + 1] = 0.5;
        الألوان[مؤشر + 2] = 1.0;
      } else if (t < 0.7) {
        الألوان[مؤشر] = 0.8;
        الألوان[مؤشر + 1] = 0.8;
        الألوان[مؤشر + 2] = 0.9;
      } else {
        الألوان[مؤشر] = 1.0;
        الألوان[مؤشر + 1] = 0.6;
        الألوان[مؤشر + 2] = 0.4;
      }

      الأحجام[i] = 0.05 + Math.random() * 0.1;
    }

    الهندسة.setAttribute("position", new THREE.BufferAttribute(المواقع, 3));
    الهندسة.setAttribute("color", new THREE.BufferAttribute(الألوان, 3));
    الهندسة.setAttribute("size", new THREE.BufferAttribute(الأحجام, 1));

    const المادة = new THREE.PointsMaterial({
      size: 0.08,
      vertexColors: true,
      transparent: true,
      opacity: 0.8,
      sizeAttenuation: true,
      blending: THREE.AdditiveBlending,
    });

    const الأذرع = new THREE.Points(الهندسة, المادة);
    المجموعة.add(الأذرع);
  }

  إنشاء_نموذج_مجرة_إهليلجية(المجموعة, الحجم, اللون) {
    const التفاصيل = 48;

    // شكل إهليلجي واقعي
    const الاهليليجية = 0.6 + Math.random() * 0.3;
    const الهندسة = new THREE.SphereGeometry(الحجم, التفاصيل, التفاصيل);

    // تشويه إلى شكل إهليلجي
    const سمة_الموقع = الهندسة.getAttribute("position");
    for (let i = 0; i < سمة_الموقع.count; i++) {
      const x = سمة_الموقع.getX(i);
      const y = سمة_الموقع.getY(i) * الاهليليجية;
      const z = سمة_الموقع.getZ(i) * (0.8 + Math.random() * 0.4);
      سمة_الموقع.setXYZ(i, x, y, z);
    }
    سمة_الموقع.needsUpdate = true;

    const المادة = new THREE.MeshPhongMaterial({
      color: اللون,
      emissive: اللون,
      emissiveIntensity: 0.2,
      shininess: 20,
      specular: new THREE.Color(0x222222),
    });

    const المجرة = new THREE.Mesh(الهندسة, المادة);
    المجموعة.add(المجرة);

    // هالة نجمية
    this.إنشاء_هالة_نجمية(المجموعة, الحجم * 1.5, اللون);
  }

  إنشاء_نموذج_مجرة_عدسية(المجموعة, الحجم, اللون) {
    const التفاصيل = 32;

    // القرص السميك
    const هندسة_القرص = new THREE.CylinderGeometry(
      الحجم * 0.9,
      الحجم * 0.9,
      الحجم * 0.2,
      التفاصيل
    );
    const مادة_القرص = new THREE.MeshPhongMaterial({
      color: اللون,
      emissive: اللون,
      emissiveIntensity: 0.2,
      side: THREE.DoubleSide,
      shininess: 40,
    });
    const القرص = new THREE.Mesh(هندسة_القرص, مادة_القرص);
    القرص.rotation.x = Math.PI / 2;
    المجموعة.add(القرص);

    // انتفاخ مركزي
    const هندسة_الانتفاخ = new THREE.SphereGeometry(
      الحجم * 0.5,
      التفاصيل,
      التفاصيل
    );
    const مادة_الانتفاخ = new THREE.MeshPhongMaterial({
      color: اللون,
      emissive: اللون,
      emissiveIntensity: 0.3,
      shininess: 30,
    });
    const الانتفاخ = new THREE.Mesh(هندسة_الانتفاخ, مادة_الانتفاخ);
    المجموعة.add(الانتفاخ);
  }

  إنشاء_نموذج_مجرة_قزمة(المجموعة, الحجم, اللون) {
    const الهندسة = new THREE.SphereGeometry(الحجم * 0.8, 16, 16);
    const المادة = new THREE.MeshPhongMaterial({
      color: اللون,
      emissive: اللون,
      emissiveIntensity: 0.4,
      transparent: true,
      opacity: 0.7,
    });

    const المجرة = new THREE.Mesh(الهندسة, المادة);
    المجموعة.add(المجرة);
  }

  إنشاء_نموذج_مجرة_غير_منتظمة(المجموعة, الحجم, اللون) {
    // استخدام هندسة غير منتظمة
    const الهندسة = new THREE.DodecahedronGeometry(الحجم, 1);

    // تشويه عشوائي
    const سمة_الموقع = الهندسة.getAttribute("position");
    for (let i = 0; i < سمة_الموقع.count; i++) {
      const x = سمة_الموقع.getX(i) * (0.7 + Math.random() * 0.6);
      const y = سمة_الموقع.getY(i) * (0.5 + Math.random() * 1.0);
      const z = سمة_الموقع.getZ(i) * (0.7 + Math.random() * 0.6);
      سمة_الموقع.setXYZ(i, x, y, z);
    }
    الهندسة.computeVertexNormals();

    const المادة = new THREE.MeshPhongMaterial({
      color: اللون,
      emissive: اللون,
      emissiveIntensity: 0.5,
      shininess: 10,
    });

    const المجرة = new THREE.Mesh(الهندسة, المادة);
    المجموعة.add(المجرة);
  }

  إنشاء_هالة_نجمية(المجموعة, الحجم, اللون) {
    const عدد_الجسيمات = 200;
    const الهندسة = new THREE.BufferGeometry();
    const المواقع = new Float32Array(عدد_الجسيمات * 3);
    const الألوان = new Float32Array(عدد_الجسيمات * 3);

    for (let i = 0; i < عدد_الجسيمات; i++) {
      const مؤشر = i * 3;
      const u = Math.pow(Math.random(), 1 / 3);
      const ثيتا = Math.random() * Math.PI * 2;
      const فاي = Math.acos(2 * Math.random() - 1);

      const نصف_القطر = u * الحجم;

      المواقع[مؤشر] = نصف_القطر * Math.sin(فاي) * Math.cos(ثيتا);
      المواقع[مؤشر + 1] = نصف_القطر * Math.sin(فاي) * Math.sin(ثيتا);
      المواقع[مؤشر + 2] = نصف_القطر * Math.cos(فاي);

      // نجوم هالة قديمة (حمراء)
      الألوان[مؤشر] = 1.0;
      الألوان[مؤشر + 1] = 0.5 + Math.random() * 0.2;
      الألوان[مؤشر + 2] = 0.3 + Math.random() * 0.2;
    }

    الهندسة.setAttribute("position", new THREE.BufferAttribute(المواقع, 3));
    الهندسة.setAttribute("color", new THREE.BufferAttribute(الألوان, 3));

    const المادة = new THREE.PointsMaterial({
      size: 0.15,
      vertexColors: true,
      transparent: true,
      opacity: 0.5,
      sizeAttenuation: true,
    });

    const الهالة = new THREE.Points(الهندسة, المادة);
    المجموعة.add(الهالة);
  }

  إنشاء_وهج_علمي(المجموعة, الحجم, اللون) {
    const هندسة_الوهج = new THREE.SphereGeometry(الحجم * 2, 16, 16);
    const مادة_الوهج = new THREE.MeshBasicMaterial({
      color: اللون,
      transparent: true,
      opacity: 0.05,
      side: THREE.BackSide,
      blending: THREE.AdditiveBlending,
    });

    const الوهج = new THREE.Mesh(هندسة_الوهج, مادة_الوهج);
    المجموعة.add(الوهج);
  }

  إنشاء_المجرة_المركزية_العملاقة(بيانات_النوع) {
    const الحجم = بيانات_النوع === this.أنواع_العناقيد.مهيمن_CD ? 10 : 6;
    const الموقع = new THREE.Vector3(0, 0, 0);

    const مجموعة_المجرة_المركزية = new THREE.Group();
    مجموعة_المجرة_المركزية.position.copy(الموقع);

    // مجرة مركزية عملاقة إهليلجية
    const الهندسة = new THREE.SphereGeometry(الحجم, 64, 64);
    const المادة = new THREE.MeshPhongMaterial({
      color: 0xff3300,
      emissive: 0xff0000,
      emissiveIntensity: 0.5,
      shininess: 100,
    });

    const المجرة_المركزية = new THREE.Mesh(الهندسة, المادة);
    مجموعة_المجرة_المركزية.add(المجرة_المركزية);

    // هالة واسعة
    const هندسة_الهالة = new THREE.SphereGeometry(الحجم * 5, 32, 32);
    const مادة_الهالة = new THREE.MeshBasicMaterial({
      color: 0xff6633,
      transparent: true,
      opacity: 0.02,
      side: THREE.BackSide,
    });

    const الهالة = new THREE.Mesh(هندسة_الهالة, مادة_الهالة);
    مجموعة_المجرة_المركزية.add(الهالة);

    مجموعة_المجرة_المركزية.userData = {
      النوع: "مجرة_مركزية_عملاقة",
      الكتلة: 1e13,
      مركزية: true,
      الخصائص_العلمية: {
        الكتلة_النجمية: 1e13,
        نصف_القطر_الفعال: الحجم * 0.5,
        تشتت_السرعة: 350, // كم/ث
        اللمعان: 5e11,
      },
    };

    this.المشهد.add(مجموعة_المجرة_المركزية);
    this.المجرات.push(مجموعة_المجرة_المركزية);
    this.العناقيد.push(مجموعة_المجرة_المركزية);
  }

  إنشاء_توزيع_المادة_المظلمة(بيانات_النوع) {
    const نصف_قطر_الهالة = this.الحصول_على_نصف_قطر_العنقود(بيانات_النوع) * 3;
    const الهندسة = new THREE.SphereGeometry(نصف_قطر_الهالة, 64, 64);

    // مادة شفافة مع نمط كثافة NFW
    const المادة = new THREE.MeshBasicMaterial({
      color: 0x330066,
      transparent: true,
      opacity: 0.03,
      side: THREE.BackSide,
      wireframe: true,
      wireframeLinewidth: 1,
    });

    this.هالة_المادة_المظلمة = new THREE.Mesh(الهندسة, المادة);
    this.المشهد.add(this.هالة_المادة_المظلمة);
    this.العناقيد.push(this.هالة_المادة_المظلمة);
  }

  إنشاء_الوسط_بين_المجري(بيانات_النوع) {
    const نصف_قطر_الوسط = this.الحصول_على_نصف_قطر_العنقود(بيانات_النوع) * 2;
    const عدد_الجسيمات = 10000;

    const الهندسة = new THREE.BufferGeometry();
    const المواقع = new Float32Array(عدد_الجسيمات * 3);
    const الألوان = new Float32Array(عدد_الجسيمات * 3);
    const درجات_الحرارة = new Float32Array(عدد_الجسيمات);

    // توزيع كثافة β-model للبلازما
    const بيتا = 0.6; // معامل النموذج
    const نصف_قطر_اللب = نصف_قطر_الوسط * 0.2;

    for (let i = 0; i < عدد_الجسيمات; i++) {
      const مؤشر = i * 3;

      // توزيع كروي
      const u = Math.pow(Math.random(), 1 / 3);
      const ثيتا = Math.random() * Math.PI * 2;
      const فاي = Math.acos(2 * Math.random() - 1);

      const نصف_القطر = u * نصف_قطر_الوسط;

      المواقع[مؤشر] = نصف_القطر * Math.sin(فاي) * Math.cos(ثيتا);
      المواقع[مؤشر + 1] = نصف_القطر * Math.sin(فاي) * Math.sin(ثيتا) * 0.8;
      المواقع[مؤشر + 2] = نصف_القطر * Math.cos(فاي);

      // كثافة البلازما
      const الكثافة = Math.pow(
        1 + Math.pow(نصف_القطر / نصف_قطر_اللب, 2),
        -1.5 * بيتا
      );

      // درجة حرارة البلازما
      const r = نصف_القطر / نصف_قطر_الوسط;
      const درجة_الحرارة = (2 + 3 * r * r) * 1e7; // 2-5 keV

      درجات_الحرارة[i] = درجة_الحرارة;

      // لون البلازما بناءً على درجة الحرارة
      if (درجة_الحرارة > 4e7) {
        // مناطق ساخنة - أزرق/أبيض
        الألوان[مؤشر] = 0.8 + 0.2 * الكثافة;
        الألوان[مؤشر + 1] = 0.8 + 0.2 * الكثافة;
        الألوان[مؤشر + 2] = 1.0;
      } else if (درجة_الحرارة > 2e7) {
        // مناطق متوسطة - أخضر/أزرق
        الألوان[مؤشر] = 0.3 * الكثافة;
        الألوان[مؤشر + 1] = 0.6 + 0.4 * الكثافة;
        الألوان[مؤشر + 2] = 0.8 + 0.2 * الكثافة;
      } else {
        // مناطق باردة نسبياً - أحمر/برتقالي
        الألوان[مؤشر] = 1.0;
        الألوان[مؤشر + 1] = 0.4 + 0.3 * الكثافة;
        الألوان[مؤشر + 2] = 0.2 * الكثافة;
      }
    }

    الهندسة.setAttribute("position", new THREE.BufferAttribute(المواقع, 3));
    الهندسة.setAttribute("color", new THREE.BufferAttribute(الألوان, 3));
    الهندسة.setAttribute(
      "temperature",
      new THREE.BufferAttribute(درجات_الحرارة, 1)
    );

    const المادة = new THREE.PointsMaterial({
      size: 0.3,
      vertexColors: true,
      transparent: true,
      opacity: 0.4,
      sizeAttenuation: true,
      blending: THREE.AdditiveBlending,
    });

    this.الوسط_بين_المجري = new THREE.Points(الهندسة, المادة);
    this.الوسط_بين_المجري.userData = {
      type: "وسط_بين_مجري",
      عدد_الجسيمات: عدد_الجسيمات,
      متوسط_درجة_الحرارة: 3e7,
    };

    this.المشهد.add(this.الوسط_بين_المجري);
    this.العناقيد.push(this.الوسط_بين_المجري);
  }

  إنشاء_مقاييس_علمية(بيانات_النوع) {
    // إنشاء مقاييس ونظم إحداثيات
    this.إنشاء_أشرطة_المقياس();
    this.إنشاء_عرض_المقاييس_الفيزيائية(بيانات_النوع);
  }

  إنشاء_أشرطة_المقياس() {
    // شريط مقياس المسافة
    const طول_المقياس = 50; // 50 وحدة = 1 ميجا فرسخ
    const هندسة_المقياس = new THREE.BoxGeometry(طول_المقياس, 0.5, 0.5);
    const مادة_المقياس = new THREE.MeshBasicMaterial({ color: 0xffffff });
    const شريط_المقياس = new THREE.Mesh(هندسة_المقياس, مادة_المقياس);
    شريط_المقياس.position.set(-100, -80, -50);
    this.المشهد.add(شريط_المقياس);
  }

  إنشاء_عرض_المقاييس_الفيزيائية(بيانات_النوع) {
    // عرض المقاييس الفيزيائية
    this.المقاييس = {
      الكتلة_الكاملة: this.حساب_الكتلة_الكاملة(بيانات_النوع),
      نصف_القطر_الفيريالي: this.الحصول_على_نصف_قطر_العنقود(بيانات_النوع),
      تشتت_السرعة: this.الفيزياء.تشتت_السرعة,
      درجة_الحرارة: بيانات_النوع.الحرارة,
      اللمعان: this.حساب_لمعان_الأشعة_السينية(بيانات_النوع),
    };
  }

  حساب_الكتلة_الكاملة(بيانات_النوع) {
    // حساب الكتلة الكلية بناءً على نوع العنقود
    const الكتل = {
      منتظم: 1e15,
      غير_منتظم: 5e14,
      مهيمن_CD: 2e15,
      متحجر: 3e14,
    };
    return الكتل[this.النوع_الحالي] || 1e14;
  }

  حساب_لمعان_الأشعة_السينية(بيانات_النوع) {
    // حساب اللمعان في أشعة X
    const اللمعان_الأساسي = {
      منتظم: "5×10^44",
      غير_منتظم: "1×10^44",
      مهيمن_CD: "10^45",
      متحجر: "5×10^43",
    };
    return اللمعان_الأساسي[this.النوع_الحالي] || "1×10^44";
  }

  تحديث_الواجهة_العلمية(بيانات_النوع) {
    // تحديث واجهة البيانات العلمية
    this.تحديث_لوحة_البيانات("معلومات-العنقود", {
      الاسم: بيانات_النوع.الاسم,
      التصنيف: بيانات_النوع.التصنيف,
      الشكل: بيانات_النوع.الشكل,
      الانزياح_الأحمر: بيانات_النوع.انزياح_الأحمر,
      مثال: بيانات_النوع.مثال,
    });

    this.تحديث_لوحة_البيانات("الخصائص-الفيزيائية", {
      الكتلة: بيانات_النوع.الكتلة,
      الحجم: بيانات_النوع.الحجم,
      الحرارة: بيانات_النوع.الحرارة,
      تشتت_السرعة: بيانات_النوع.تشتت_السرعة,
      المادة_المظلمة: بيانات_النوع.المادة_المظلمة,
    });

    this.تحديث_لوحة_البيانات("البيانات-العلمية", بيانات_النوع.بيانات_علمية);

    // تحديث المقاييس الحية
    this.تحديث_المقاييس_الحية();
  }

  تحديث_لوحة_البيانات(معرف_اللوحة, البيانات) {
    const اللوحة = document.getElementById(معرف_اللوحة);
    if (!اللوحة) return;

    let HTML = "";
    for (const [المفتاح, القيمة] of Object.entries(البيانات)) {
      HTML += `<div class="صف-البيانات">
                <span class="تسمية-البيانات">${this.تنسيق_التسمية(
                  المفتاح
                )}:</span>
                <span class="قيمة-البيانات">${القيمة}</span>
            </div>`;
    }

    اللوحة.innerHTML = HTML;
  }

  تنسيق_التسمية(التسمية) {
    // تحويل التسمية إلى شكل مقروء
    const التسميات = {
      اللمعان_الأشعة_السينية: "اللمعان في الأشعة السينية",
      كتلة_الغاز: "كتلة الغاز",
      الكتلة_الكاملة: "الكتلة الكاملة",
      زمن_التبريد: "زمن التبريد",
      المعدنية: "المعدنية",
      الاسم: "الاسم",
      التصنيف: "التصنيف",
      الشكل: "الشكل",
      الانزياح_الأحمر: "الانزياح الأحمر",
      مثال: "المثال",
      الكتلة: "الكتلة",
      الحجم: "الحجم",
      الحرارة: "درجة الحرارة",
      تشتت_السرعة: "تشتت السرعة",
      المادة_المظلمة: "المادة المظلمة",
    };

    return التسميات[التسمية] || التسمية;
  }

  تحديث_المقاييس_الحية() {
    // تحديث المقاييس الحية أثناء المحاكاة
    const لوحة_المقاييس = document.getElementById("المقاييس-الحية");
    if (!لوحة_المقاييس) return;

    const HTML = `
            <div class="مقياس">
                <span class="تسمية-المقياس">الكتلة الكاملة:</span>
                <span class="قيمة-المقياس">${(
                  this.المقاييس.الكتلة_الكاملة / 1e14
                ).toFixed(2)} × 10¹⁴ كتلة شمسية</span>
            </div>
            <div class="مقياس">
                <span class="تسمية-المقياس">نصف القطر الفيريالي:</span>
                <span class="قيمة-المقياس">${this.المقاييس.نصف_القطر_الفيريالي.toFixed(
                  1
                )} ميجا فرسخ</span>
            </div>
            <div class="مقياس">
                <span class="تسمية-المقياس">تشتت السرعة:</span>
                <span class="قيمة-المقياس">${
                  this.المقاييس.تشتت_السرعة
                } كم/ث</span>
            </div>
            <div class="مقياس">
                <span class="تسمية-المقياس">درجة الحرارة:</span>
                <span class="قيمة-المقياس">${this.المقاييس.درجة_الحرارة}</span>
            </div>
            <div class="مقياس">
                <span class="تسمية-المقياس">اللمعان في الأشعة السينية:</span>
                <span class="قيمة-المقياس">${this.المقاييس.اللمعان} إرج/ث</span>
            </div>
        `;

    لوحة_المقاييس.innerHTML = HTML;
  }

  إعداد_الواجهة() {
    // إعداد عناصر التحكم العلمية
    this.إعداد_عناصر_التحكم_العلمية();
    this.إنشاء_لوحات_البيانات();
  }

  إعداد_عناصر_التحكم_العلمية() {
    // أزرار التحكم العلمية
    document.getElementById("نوع-العنقود").addEventListener("change", (e) => {
      this.النوع_الحالي = e.target.value;
      this.إنشاء_العنقود();
    });

    document
      .getElementById("تبديل-المادة-المظلمة")
      .addEventListener("change", (e) => {
        this.عرض_المادة_المظلمة = e.target.checked;
        this.إنشاء_العنقود();
      });

    document
      .getElementById("تبديل-الوسط-بين-المجري")
      .addEventListener("change", (e) => {
        this.عرض_الوسط_بين_المجري = e.target.checked;
        this.إنشاء_العنقود();
      });

    document
      .getElementById("تبديل-متجهات-السرعة")
      .addEventListener("change", (e) => {
        this.عرض_متجهات_السرعة = e.target.checked;
        this.تحديث_التصوير();
      });

    document
      .getElementById("تبديل-خريطة-الحرارة")
      .addEventListener("change", (e) => {
        this.عرض_خريطة_الحرارة = e.target.checked;
        this.تحديث_التصوير();
      });

    document.getElementById("مقياس-الزمن").addEventListener("input", (e) => {
      this.مقياس_الزمن = parseFloat(e.target.value);
      document.getElementById(
        "قيمة-مقياس-الزمن"
      ).textContent = `${this.مقياس_الزمن}x`;
    });

    document.getElementById("وضع-البحث").addEventListener("change", (e) => {
      this.وضع_البحث = e.target.checked;
      this.تبديل_وضع_البحث();
    });
  }

  إنشاء_لوحات_البيانات() {
    // إنشاء لوحات البيانات العلمية
    const اللوحات = [
      {
        المعرف: "معلومات-العنقود",
        العنوان: "معلومات العنقود",
        الموقع: "أعلى-يمين",
        البيانات: {},
      },
      {
        المعرف: "الخصائص-الفيزيائية",
        العنوان: "الخصائص الفيزيائية",
        الموقع: "أعلى-يسار",
        البيانات: {},
      },
      {
        المعرف: "البيانات-العلمية",
        العنوان: "البيانات العلمية",
        الموقع: "أسفل-يمين",
        البيانات: {},
      },
      {
        المعرف: "المقاييس-الحية",
        العنوان: "المقاييس الحية",
        الموقع: "أسفل-يسار",
        البيانات: {},
      },
    ];

    اللوحات.forEach((لوحة) => {
      this.لوحات_البيانات[لوحة.المعرف] = لوحة;
    });
  }

  إعداد_مستمعي_الأحداث() {
    window.addEventListener("resize", () => this.عند_تغيير_حجم_النافذة());

    // أحداث النقر للتفاعل مع المجرات
    this.المصيِّر.domElement.addEventListener("click", (event) =>
      this.عند_النقر_على_المجرة(event)
    );

    // أحداث لوحة المفاتيح للتحكم العلمي
    document.addEventListener("keydown", (event) =>
      this.عند_الضغط_على_مفتاح(event)
    );
  }

  عند_تغيير_حجم_النافذة() {
    this.الكاميرا.aspect = window.innerWidth / window.innerHeight;
    this.الكاميرا.updateProjectionMatrix();
    this.المصيِّر.setSize(window.innerWidth, window.innerHeight);
  }

  عند_النقر_على_المجرة(الحدث) {
    // تحديد المجرة التي تم النقر عليها
    const الفأر = new THREE.Vector2();
    الفأر.x = (الحدث.clientX / window.innerWidth) * 2 - 1;
    الفأر.y = -(الحدث.clientY / window.innerHeight) * 2 + 1;

    const راي_كاستر = new THREE.Raycaster();
    راي_كاستر.setFromCamera(الفأر, this.الكاميرا);

    const التقاطعات = راي_كاستر.intersectObjects(this.المجرات);
    if (التقاطعات.length > 0) {
      const المجرة = التقاطعات[0].object.parent || التقاطعات[0].object;
      this.عرض_معلومات_المجرة(المجرة.userData);
    }
  }

  عرض_معلومات_المجرة(البيانات) {
    // عرض معلومات مفصلة عن المجرة
    const المعلومات = `
            <h3>تحليل المجرة</h3>
            <p><strong>النوع:</strong> ${البيانات.النوع}</p>
            <p><strong>الكتلة النجمية:</strong> ${(
              البيانات.الخصائص_العلمية.الكتلة_النجمية / 1e9
            ).toFixed(2)} × 10⁹ كتلة شمسية</p>
            <p><strong>كتلة الغاز:</strong> ${(
              البيانات.الخصائص_العلمية.كتلة_الغاز / 1e9
            ).toFixed(2)} × 10⁹ كتلة شمسية</p>
            <p><strong>معدل تشكل النجوم:</strong> ${البيانات.الخصائص_العلمية.معدل_تشكل_النجوم.toFixed(
              3
            )} كتلة شمسية/سنة</p>
            <p><strong>المعدنية:</strong> ${البيانات.الخصائص_العلمية.المعدنية.toFixed(
              3
            )} كتلة شمسية</p>
            <p><strong>العمر:</strong> ${(
              البيانات.الخصائص_العلمية.العمر / 1e9
            ).toFixed(1)} مليار سنة</p>
        `;

    document.getElementById("تفاصيل-المجرة").innerHTML = المعلومات;
    document.getElementById("تفاصيل-المجرة").classList.remove("مخفي");
  }

  عند_الضغط_على_مفتاح(الحدث) {
    // اختصارات لوحة المفاتيح للباحثين
    switch (الحدث.key) {
      case "1":
        this.النوع_الحالي = "منتظم";
        break;
      case "2":
        this.النوع_الحالي = "غير_منتظم";
        break;
      case "3":
        this.النوع_الحالي = "مهيمن_CD";
        break;
      case "4":
        this.النوع_الحالي = "متحجر";
        break;
      case "d":
        this.عرض_المادة_المظلمة = !this.عرض_المادة_المظلمة;
        break;
      case "i":
        this.عرض_الوسط_بين_المجري = !this.عرض_الوسط_بين_المجري;
        break;
      case "v":
        this.عرض_متجهات_السرعة = !this.عرض_متجهات_السرعة;
        break;
      case "t":
        this.عرض_خريطة_الحرارة = !this.عرض_خريطة_الحرارة;
        break;
      case "r":
        this.وضع_البحث = !this.وضع_البحث;
        break;
      case "c":
        this.محاكاة_التصادم = !this.محاكاة_التصادم;
        break;
      default:
        return;
    }

    if (["1", "2", "3", "4"].includes(الحدث.key)) {
      this.إنشاء_العنقود();
    } else {
      this.تحديث_التصوير();
    }

    الحدث.preventDefault();
  }

  تحديث_التصوير() {
    // تحديث العرض المرئي بناءً على الإعدادات
    if (this.هالة_المادة_المظلمة) {
      this.هالة_المادة_المظلمة.visible = this.عرض_المادة_المظلمة;
    }

    if (this.الوسط_بين_المجري) {
      this.الوسط_بين_المجري.visible = this.عرض_الوسط_بين_المجري;
    }

    // تحديث ألوان البلازما لخريطة الحرارة
    if (this.عرض_خريطة_الحرارة && this.الوسط_بين_المجري) {
      this.تحديث_ألوان_درجة_الحرارة();
    }
  }

  تحديث_ألوان_درجة_الحرارة() {
    // تحديث ألوان البلازما بناءً على درجة الحرارة
    const الألوان = this.الوسط_بين_المجري.geometry.attributes.color.array;
    const درجات_الحرارة =
      this.الوسط_بين_المجري.geometry.attributes.temperature.array;

    for (let i = 0; i < درجات_الحرارة.length; i++) {
      const مؤشر = i * 3;
      const الحرارة = درجات_الحرارة[i];

      // خريطة ألوان علمية لدرجة الحرارة
      if (الحرارة > 5e7) {
        الألوان[مؤشر] = 1.0; // أحمر
        الألوان[مؤشر + 1] = 0.2; // أخضر
        الألوان[مؤشر + 2] = 0.2; // أزرق
      } else if (الحرارة > 3e7) {
        الألوان[مؤشر] = 1.0;
        الألوان[مؤشر + 1] = 0.6;
        الألوان[مؤشر + 2] = 0.0;
      } else if (الحرارة > 1e7) {
        الألوان[مؤشر] = 1.0;
        الألوان[مؤشر + 1] = 1.0;
        الألوان[مؤشر + 2] = 0.0;
      } else if (الحرارة > 5e6) {
        الألوان[مؤشر] = 0.0;
        الألوان[مؤشر + 1] = 1.0;
        الألوان[مؤشر + 2] = 0.0;
      } else {
        الألوان[مؤشر] = 0.0;
        الألوان[مؤشر + 1] = 0.0;
        الألوان[مؤشر + 2] = 1.0;
      }
    }

    this.الوسط_بين_المجري.geometry.attributes.color.needsUpdate = true;
  }

  تبديل_وضع_البحث() {
    // تبديل وضع البحث (عرض بيانات إضافية)
    if (this.وضع_البحث) {
      this.عرض_متجهات_السرعة = true;
      this.عرض_خريطة_الحرارة = true;
      this.إنشاء_متجهات_السرعة();
      document.getElementById("مؤشر-وضع-البحث").style.display = "block";
    } else {
      this.عرض_متجهات_السرعة = false;
      this.عرض_خريطة_الحرارة = false;
      this.إزالة_متجهات_السرعة();
      document.getElementById("مؤشر-وضع-البحث").style.display = "none";
    }
    this.تحديث_التصوير();
  }

  إنشاء_متجهات_السرعة() {
    // إنشاء أسهم السرعة للمجرات
    this.متجهات_السرعة = new THREE.Group();

    this.المجرات.forEach((مجرة) => {
      if (مجرة.userData.السرعة) {
        const السرعة = مجرة.userData.السرعة.clone().multiplyScalar(100);
        const السهم = this.إنشاء_سهم_السرعة(السرعة);
        السهم.position.copy(مجرة.position);
        this.متجهات_السرعة.add(السهم);
      }
    });

    this.المشهد.add(this.متجهات_السرعة);
  }

  إنشاء_سهم_السرعة(السرعة) {
    const الاتجاه = السرعة.clone().normalize();
    const الطول = السرعة.length();

    const السهم = new THREE.ArrowHelper(
      الاتجاه,
      new THREE.Vector3(0, 0, 0),
      الطول,
      0xff0000,
      0.3 * الطول,
      0.1 * الطول
    );

    return السهم;
  }

  إزالة_متجهات_السرعة() {
    if (this.متجهات_السرعة) {
      this.المشهد.remove(this.متجهات_السرعة);
      this.متجهات_السرعة = null;
    }
  }

  مسح_العنقود_السابق() {
    // مسح العنقود السابق
    this.المجرات.forEach((مجرة) => this.المشهد.remove(مجرة));
    this.العناقيد.forEach((عنقود) => {
      if (
        عنقود !== this.هالة_المادة_المظلمة &&
        عنقود !== this.الوسط_بين_المجري
      ) {
        this.المشهد.remove(عنقود);
      }
    });

    this.المجرات = [];
    this.العناقيد = this.العناقيد.filter(
      (ج) => ج === this.هالة_المادة_المظلمة || ج === this.الوسط_بين_المجري
    );

    if (this.متجهات_السرعة) {
      this.المشهد.remove(this.متجهات_السرعة);
      this.متجهات_السرعة = null;
    }
  }

  تسجيل_بيانات_العنقود(بيانات_النوع, عدد_المجرات) {
    // تسجيل بيانات المحاكاة لأغراض البحث
    const بيانات_المحاكاة = {
      الطابع_الزمني: new Date().toISOString(),
      نوع_العنقود: this.النوع_الحالي,
      عدد_المجرات: عدد_المجرات,
      الكتلة_الكاملة: this.المقاييس.الكتلة_الكاملة,
      نسبة_المادة_المظلمة: parseFloat(بيانات_النوع.المادة_المظلمة) / 100,
      درجة_الحرارة: بيانات_النوع.الحرارة,
      معلمات_المحاكاة: {
        مقياس_الزمن: this.مقياس_الزمن,
        عرض_المادة_المظلمة: this.عرض_المادة_المظلمة,
        عرض_الوسط_بين_المجري: this.عرض_الوسط_بين_المجري,
        وضع_البحث: this.وضع_البحث,
      },
    };

    console.log("بيانات المحاكاة:", بيانات_المحاكاة);

    // حفظ البيانات في التخزين المحلي
    localStorage.setItem("آخر_محاكاة", JSON.stringify(بيانات_المحاكاة));
  }

  تسجيل_بدء_المحاكاة() {
    console.log(`
            ============================================
            محاكاة عناقيد المجرات النسخة 2.0 - العلمية
            ============================================
            المؤلف: مجموعة البحث في الفيزياء الفلكية
            الغرض: محاكاة تعليمية وبحثية
            المميزات:
            - توزيعات واقعية للمجرات
            - نمذجة هالة المادة المظلمة
            - محاكاة الوسط بين المجري
            - مقاييس وبيانات علمية
            - وضع البحث للتحليل
            ============================================
        `);
  }

  بدء_الحركة() {
    const تحريك = () => {
      requestAnimationFrame(تحريك);
      this.تحديث();
      this.تصيير();
    };
    تحريك();
  }

  تحديث() {
    const دلتا = this.الساعة.getDelta() * this.مقياس_الزمن;
    this.زمن_المحاكاة += دلتا;

    // تحديث حركة المجرات
    this.المجرات.forEach((مجرة) => {
      if (مجرة.userData.سرعة_الدوران) {
        مجرة.rotation.y += مجرة.userData.سرعة_الدوران * دلتا * 60;
      }

      // حركة مدارية (مبسطة)
      if (مجرة.userData.السرعة && !مجرة.userData.مركزية) {
        مجرة.position.add(مجرة.userData.السرعة.clone().multiplyScalar(دلتا));

        // جاذبية مركزية مبسطة
        const إلى_المركز = new THREE.Vector3().sub(مجرة.position).normalize();
        const الجاذبية = 0.0001 * دلتا;
        مجرة.userData.السرعة.add(إلى_المركز.multiplyScalar(الجاذبية));
      }
    });

    // تحديث الواجهة
    this.تحديث_المقاييس_الحية();

    // تحديث التحكم
    this.التحكم.update();
  }

  تصيير() {
    this.المصيِّر.render(this.المشهد, this.الكاميرا);
  }

  // وظائف مساعدة للبحث
  تصدير_البيانات() {
    const البيانات = {
      المجرات: this.المجرات.map((ج) => ({
        النوع: ج.userData.النوع,
        الكتلة: ج.userData.الكتلة,
        الموقع: ج.position.toArray(),
        السرعة: ج.userData.السرعة.toArray(),
        الخصائص: ج.userData.الخصائص_العلمية,
      })),
      العنقود: {
        النوع: this.النوع_الحالي,
        المقاييس: this.المقاييس,
        المادة_المظلمة: this.عرض_المادة_المظلمة,
        الوسط_بين_المجري: this.عرض_الوسط_بين_المجري,
      },
      المحاكاة: {
        الزمن: this.زمن_المحاكاة,
        الطابع_الزمني: new Date().toISOString(),
      },
    };

    return JSON.stringify(البيانات, null, 2);
  }

  حفظ_المحاكاة() {
    const البيانات = this.تصدير_البيانات();
    const كتلة_البيانات = new Blob([البيانات], { type: "application/json" });
    const الرابط = URL.createObjectURL(كتلة_البيانات);
    const رابط = document.createElement("a");
    رابط.href = الرابط;
    رابط.download = `عنقود_المجرات_${this.النوع_الحالي}_${Date.now()}.json`;
    رابط.click();
    URL.revokeObjectURL(الرابط);
  }

  التقاط_صورة() {
    this.المصيِّر.domElement.toBlob((كتلة_بيانات) => {
      const الرابط = URL.createObjectURL(كتلة_بيانات);
      const رابط = document.createElement("a");
      رابط.href = الرابط;
      رابط.download = `لقطة_العنقود_${Date.now()}.png`;
      رابط.click();
      URL.revokeObjectURL(الرابط);
    }, "image/png");
  }
}

// بدء المحاكاة عند تحميل الصفحة
document.addEventListener("DOMContentLoaded", () => {
  // التحقق من دعم WebGL
  try {
    const المحاكاة = new محاكاة_عناقيد_المجرات();

    // جعل المحاكاة متاحة عالمياً للاستخدام في وحدة التحكم
    window.محاكاة_المجرات = المحاكاة;

    console.log("محاكاة عناقيد المجرات النسخة 2.0 - جاهزة للبحث");
    console.log("الأوامر المتاحة:");
    console.log("- محاكاة_المجرات.حفظ_المحاكاة()");
    console.log("- محاكاة_المجرات.التقاط_صورة()");
    console.log("- محاكاة_المجرات.تصدير_البيانات()");
  } catch (خطأ) {
    console.error("فشل في تهيئة المحاكاة:", خطأ);
    document.getElementById("حاوية-العناقيد").innerHTML = `
            <div style="color: white; padding: 20px; background: rgba(0,0,0,0.8); text-align: center; direction: rtl;">
                <h2>فشل في تهيئة المحاكاة</h2>
                <p>الخطأ: ${خطأ.message}</p>
                <p>الرجاء التأكد من أن متصفحك يدعم WebGL 2.0</p>
                <p>يوصى باستخدام Chrome أو Firefox الحديث</p>
            </div>
        `;
  }
});
